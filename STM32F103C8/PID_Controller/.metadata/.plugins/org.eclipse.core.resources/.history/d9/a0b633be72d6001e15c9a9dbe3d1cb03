/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2024 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */

/*===============================================================================
 *                                Includes                                       *
 ================================================================================*/

#include "stm32f103c8.h"
#include "stm32f103c8_rcc_driver.h"
#include "stm32f103c8_exti_driver.h"
#include "stm32f103c8_gpio_driver.h"
#include "stm32f103c8_timer_driver.h"
#include "pid.h"

/*===============================================================================
 *                            		  MACROS	                                 *
 ================================================================================*/



/*===============================================================================
 *                              Global Variables                                 *
 ================================================================================*/
vsint32_t PID_Res = 0;
vsint32_t Position = 0;


/*===============================================================================
 *                                	   ISR 		   		               	 	     *
 ================================================================================*/
void EncoderISR(void)
{
	sint32_t b = MCAL_GPIO_ReadPin(GPIOA, GPIO_PIN5);

	if(b > 0)
		Position--;
	else
		Position++;
}

/*===============================================================================
 *                                Application 		   		                     *
 ================================================================================*/
int main(void)
{
	MCAL_RCC_initSYSClk();

	EXTI_PinConfig_t exti_cfg;
	exti_cfg.EXTIx_Pin = EXTI4PA4;
	exti_cfg.EXTI_TriggerCase = EXTI_RISING_TRIG;
	exti_cfg.EXTI_IRQ = EXTI_IRQ_ENABLE;
	exti_cfg.p_EXTI_ISR_CallBack = EncoderISR;
	MCAL_EXTI_GPIO_Init(&exti_cfg);

	GPIO_PinConfig_t gpio_cfg;
	gpio_cfg.GPIO_PinNumber = GPIO_PIN5;
	gpio_cfg.GPIO_Mode = GPIO_MODE_INPUT_FLOATING;
	MCAL_GPIO_Init(GPIOA, &gpio_cfg);

	PID_Controller pid;
	pid.Kp = 60.0;
	pid.Ki = 0.01;
	pid.Kd = 10.0;
	pid.T = 1;
	pid.MaxLimit = 1000;
	pid.MinLimit = -1000;
	PID_Init(&pid);



    /* Loop forever */
	while(1)
	{
		PID_Res = PID_Update(&pid, 200, Position);
		if(PID_Res > 0)
		{
			MCAL_Tim_PWM(TIM1, CHANNEL3, 0, 1000, 8000);
			MCAL_Tim_PWM(TIM1, CHANNEL1, PID_Res, 1000, 8000);

		}else if(PID_Res < 0)
		{
			MCAL_Tim_PWM(TIM1, CHANNEL3, -PID_Res, 1000, 8000);
			MCAL_Tim_PWM(TIM1, CHANNEL1, 0, 1000, 8000);

		}else
		{
			MCAL_Tim_PWM(TIM1, CHANNEL3, 0, 1000, 8000);
			MCAL_Tim_PWM(TIM1, CHANNEL1, 0, 1000, 8000);
		}
	}
}
